<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>About & Profile PDF ‚Ä¢ M Share</title>
  <meta name="description" content="About M Share and a styled, one‚Äëpage PDF of my profile with active links. Share my profile, download or share a PNG/PDF preview, and manage an on‚Äëdevice store.">
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --b: rgba(148,163,184,.25);
      --fg: #e8eef6;
      --muted: rgba(203,213,225,.8);
      --surface:#0a1020;
      --shadow-1: 0 8px 34px rgba(0,0,0,.35);
      --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
    }
    body{background:#050a18;color:var(--fg);}

    .preview{border:1px solid var(--b);border-radius:16px;overflow:hidden;box-shadow:var(--shadow-1);
      background:#0a0a0a;display:grid;place-items:center;height:min(85vh,860px)}
    .preview canvas{width:100%;height:auto;display:block}

    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .field{display:grid;gap:4px}
    .field input,.field textarea,.field select{border:1px solid var(--b);background:#0a1020;color:var(--fg);
      border-radius:10px;padding:10px 12px}
    .field textarea{min-height:88px;resize:vertical}
    .divider{height:1px;background:rgba(148,163,184,.18);margin:10px 0}
    .subtle{color:var(--muted);font-size:.95rem}
    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
    .admin-only{display:none} /* hidden until unlocked */

    /* Admin unlock modal */
    .modal{position:fixed;inset:0;background:rgba(3,8,18,.6);display:none;place-items:center;z-index:1000}
    .modal.open{display:grid}
    .modal-card{width:min(460px,96vw);background:var(--surface);border:1px solid var(--b);border-radius:16px;
      box-shadow:var(--shadow-1);padding:16px}
    .pass-row{display:flex;gap:8px;align-items:center}
    .pass-row input{flex:1}
    .timer{margin-top:8px;color:var(--warn);font-size:.95rem}
    .muted small{opacity:.9}

    /* Small helper tag beside inputs */
    .note-chip{display:inline-block;font-size:.8rem;margin-left:8px;color:var(--muted)}

    /* About readability */
    .about p{max-width:72ch;line-height:1.55}
    .about h2,.about h3{margin:0.2rem 0 0.4rem}

    /* Accordion styles */
    details.accordion{
      border:1px solid var(--b);
      border-radius:12px;
      background:var(--surface, #0a1020);
      padding:8px 10px;
      margin-top:10px;
    }
    details.accordion[open]{box-shadow:var(--shadow-1)}
    details.accordion summary{
      list-style:none;
      cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;
      font-weight:600;
      padding:6px 4px;
    }
    details.accordion summary::-webkit-details-marker{display:none}
    details.accordion summary::after{
      content:'‚ñæ';
      transition:transform .2s ease;margin-left:8px;
    }
    details.accordion[open] summary::after{ transform: rotate(180deg); }
    .accordion-body{padding:6px 2px 2px;border-top:1px solid rgba(148,163,184,.18);margin-top:6px}
    .accordion-body p{margin:0.6rem 0}

    /* Public profile data grid */
    .data-grid{display:grid;grid-template-columns:minmax(140px,220px) 1fr;gap:8px 12px;align-items:start}
    .data-grid .k{color:var(--muted)}
    .data-grid .v a{color:#7dd3fc;text-decoration:underline}
    .thumb{inline-size:72px;block-size:72px;border-radius:50%;object-fit:cover;border:1px solid var(--b)}
    .thumb-bg{inline-size:120px;block-size:60px;border-radius:10px;object-fit:cover;border:1px solid var(--b)}

    /* Simple container/card defaults in case style.css is missing */
    .container{max-width:1100px;margin:0 auto;padding:14px}
    .card{border:1px solid var(--b);border-radius:16px;padding:14px 16px;margin:12px 0;background:rgba(10,16,32,.6)}
    header.site-header{position:sticky;top:0;background:rgba(5,10,24,.8);backdrop-filter: blur(6px);border-bottom:1px solid var(--b);z-index:10}
    .navbar{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--fg);font-weight:700}
    .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#0ea5e9;color:#001018;font-weight:800}
    .main-nav{display:flex;gap:10px;align-items:center}
    .main-nav a, .btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;text-decoration:none;background:#0c1228;color:var(--fg)}
    .btn-primary{background:#0ea5e9;border-color:#0ea5e9;color:#001018;font-weight:700}
    .btn-danger{background:#ef4444;border-color:#ef4444}
    .btn-success{background:#22c55e;border-color:#22c55e;color:#06120a}
    .nav-toggle{display:none}
    @media (max-width:720px){ .main-nav{display:none} .nav-toggle{display:block} }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container navbar">
    <a id="brandLink" class="brand" href="index.html"><span class="logo">M</span> M Share</a>
    <nav class="main-nav" id="mainNav">
      <a href="index.html" data-href="index.html">Wellbeing</a>
      <a href="bank.html" data-href="bank.html">Buy me coffee</a>
      <a href="#about" data-href="#about">About</a>
      <button id="shareOpen" class="btn" type="button" aria-haspopup="dialog"><span class="icon">üîó</span> Share</button>
    </nav>
    <button id="navToggle" class="nav-toggle" aria-label="Menu">‚ò∞</button>
  </div>
</header>

<main class="container">
  <!-- ===== ABOUT ===== -->
  <div class="card about" id="about">
    <h1>About</h1>

    <p class="muted">
      Hello, I‚Äôm Alkhadi Koroma, London‚Äëbased and proudly dyslexic. Growing up as one of fifteen children, I wrestled with words but fell in love with problem‚Äësolving. These tools‚Äîcolour overlays, chunked reading drills, paced breathing, focus timers, and gentle reminders‚Äîhelped me graduate and become the first in my family to earn a Computer Science degree. I built M Share to pass that lifeline to every neurodivergent learner‚Äîand to parents seeking understanding and calm‚Äîto help us co‚Äëexist. If this space helps you breathe easier, learn faster, or feel seen, please tap ‚ÄúBuy me coffee.‚Äù Your support funds new features, guides, and access.
    </p>

    <!-- Story accordion (CLOSED by default) -->
    <details class="accordion" id="fullStory">
      <summary class="accordion-summary">Read More</summary>
      <div class="accordion-body">
        <p>I live in Southwark, London, where double‚Äëdecker buses hum like metronomes and the Thames reminds you to keep moving. For years, my days started early‚Äîcoding in the quiet, building small tools I needed myself‚Äîthen driving private hire across the city, picking up stories from people heading to interviews, hospitals, schools, and first dates. Dyslexia shaped my routes as surely as any sat‚Äënav: I take the road that gives me time to think, the one with cleaner signage, the one that lets me rehearse a conversation twice before I say a word. M Share began as a folder of these hacks‚Äîlittle bridges over noisy gaps in attention and memory‚Äîbecause I believed what carried me could carry others, too.</p>
        <p>At school I learned to measure progress in breaths, not pages. Breathing tools became my first lifeline: four seconds in, six out, repeated until the letters stopped shaking. When revision turned to fog, I used colour overlays and the screen settled down. Chunked reading taught me to trust small wins‚Äîthree lines, then a break; one paragraph, then a note to future me. I wrote scripts that nudged me kindly: ‚ÄúStand, breathe, blink, sip water.‚Äù The first time those prompts ran on my phone, I cried‚Äînot because the code was clever, but because the compassion was. M Share is the public version of that private kindness.</p>
        <p>University was a landslide and a lighthouse at once. Lectures moved fast; assignment briefs felt like riddles dropped in a storm. But the tools worked. A dyslexia trainer I prototyped made words behave: spacing widened, backgrounds shifted to a calmer blue, and exercises gamified the practice of decoding shape before sound. A focus timer turned ninety minutes into a train of gentle stops‚Äîwork, pause, breathe, repeat‚Äîuntil the track ran out exactly at submission. On the day I graduated‚Äîfirst in a family of fifteen to hold a Computer Science degree‚ÄîI recognised the real certificate was a mindset: there are many legitimate ways to learn, and each deserves an app that meets it halfway.</p>
        <p>That belief is why M Share is both toolbox and table. Toolbox, because you will find practical, low‚Äëfriction helpers: breathing sequences that open on a tap; reading modes that shift contrast and spacing instantly; a mood page that treats emotions like weather‚Äîreal, passing, and worthy of a forecast; gentle reminders that respect dignity. Table, because community matters: parents can sit beside their neurodivergent children and try settings together; teachers can borrow templates for accessible handouts; students can share what actually works at 2‚ÄØa.m. before a deadline. I built the interface to be quiet, roomy, and forgiving‚Äîthe way I wish every classroom had felt.</p>
        <p>London taught me another lesson: synergy. The city only functions because millions of differences coordinate. Neurodivergence is not a malfunction; it is a different form of coordination. When we tune the environment‚Äîfonts, colours, timing, feedback‚Äîthe person doesn‚Äôt change; the world meets them where they are. M Share, in its best moments, is a tuning fork. Switch to the dyslexia‚Äëfriendly overlay, and your eyes exhale. Start the paced‚Äëbreathing guide, and your mind re‚Äëenters the room. Use the chunked‚Äëreading trainer, and paragraphs become stepping stones instead of waves. I cannot promise miracles, but I can promise craft, iteration, and a listening ear.</p>
        <p>Your support does concrete things. A coffee funds hosting, accessibility audits, and the small design details that make the difference between ‚Äúusable‚Äù and ‚ÄúI can finally do this.‚Äù It pays for expert consultations so I can translate best practice into friendly defaults. It turns ideas into features: a parent view with plain‚Äëlanguage guides; printable worksheets that mirror the on‚Äëscreen trainers; an offline mode for low‚Äëconnectivity households; gentle analytics that help you see which settings helped most. I test every addition with one question: would this have helped teenage me finish that page without shame?</p>
        <p>I also need your feedback. Tell me what feels clumsy, what took too many taps, what wording made you hesitate. Request features shamelessly. If you‚Äôre a parent, say which parts helped you understand your child‚Äôs day. If you‚Äôre a student, describe the moment something clicked. If you‚Äôre a teacher or therapist, lend the phrases you use when you explain dyslexia to a nervous family‚ÄîI will bake them into the product. This is a living project; your notes are blueprints.</p>
        <p>Most nights, after a late shift, I still open the builder and refine a corner: a focus ring brighter here, a label kinder there. I do it because I remember the library desk where I nearly gave up, and the bus ride where a stranger said, ‚ÄúTry changing the background‚Äîyou‚Äôll be surprised.‚Äù They were right. If M Share surprises you into a calmer breath, a completed paragraph, a kinder day, then it is working. If it earns your trust, please tap Buy me coffee. You will help me help the next person breathe, read, finish, and feel seen.</p>
      </div>
    </details>

    <div class="actions" style="margin:10px 0 6px">
      <a class="btn btn-primary" href="bank.html" data-href="bank.html">‚òï Buy me coffee</a>
    </div>
  </div>



  <!-- ===== PROFILE PDF ===== -->
  <div class="card">
    <h1>Styled Profile PDF</h1>
    <p class="muted">
      <b>What you can do here</b> ‚Äî Download my profile as a <b>single‚Äëpage PDF with active links</b> (tap to call, text, email, visit the site, wellbeing page, maps, or ‚ÄúBuy me coffee‚Äù).  
      You can also save a <b>PNG preview</b> of the card. The QR opens the <b>About</b> section of this page and shows my avatar in the centre.
    </p>

    <div class="actions" style="margin:10px 0 14px">
      <button id="downloadPdf" class="btn btn-primary">‚¨á Download Profile PDF</button>
      <button id="savePreview" class="btn">üñºÔ∏è Save Preview PNG</button>
      <span class="muted" style="margin-left:auto"><button id="adminUnlockBtn" class="btn">üîí Admin</button></span>
    </div>

    <div id="previewWrap" class="preview">
      <canvas id="pdfPreview" width="1224" height="1584" aria-label="PDF preview canvas"></canvas>
    </div>
  </div>

  <!-- ========== ADMIN DECK (hidden) ========== -->
  <div id="adminDeck" class="admin-only">
    <div class="card">
      <h2>Store (Device Locker)</h2>
      <p class="muted">Keep multiple PDFs locally on this device (offline). Quota: <span id="lockerQuota">0 B / ‚àû</span> used.</p>
      <div class="row-actions" style="margin-bottom:10px">
        <label class="btn">‚ûï Add PDF<input id="addPdf" type="file" accept="application/pdf" style="display:none"></label>
        <button id="makePlaceholder" class="btn">üìù Make styled placeholder</button>
        <button id="saveToStore" class="btn">üì¶ Save current PDF to Store</button>
        <button id="exportLocker" class="btn">üì§ Export Locker (.json)</button>
        <label class="btn">üì• Import Locker<input id="importLocker" type="file" accept="application/json" style="display:none"></label>
      </div>
      <div id="lockerList" class="kv-grid"></div>
    </div>

    <div class="card">
      <h2>Live Profile Editor</h2>
      <p class="muted">Edit the default profile. Changes update the preview instantly and <b>auto‚Äësave</b> to this device. You can also download an updated <code>assets/default_profile.json</code> for deployment.</p>

      <div class="grid-2" style="margin-top:8px">
        <div class="field"><label>Name</label><input id="e_name" placeholder="Full name"></div>
        <div class="field"><label>Title</label><input id="e_title" placeholder="Professional title"></div>
        <div class="field"><label>Phone</label><input id="e_phone" placeholder="+44‚Ä¶"></div>
        <div class="field"><label>Email</label><input id="e_email" placeholder="you@mail.com"></div>
        <div class="field"><label>Website</label><input id="e_site" placeholder="https://‚Ä¶"></div>
        <div class="field"><label>Wellbeing link</label><input id="e_wb" placeholder="https://‚Ä¶"></div>
        <div class="field">
          <label>Avatar (URL or upload) <span class="note-chip">PNG/JPG</span></label>
          <div class="row-actions">
            <input id="e_avatar" style="flex:1" placeholder="assets/alkhadi.png">
            <label class="btn">Upload<input id="e_avatar_file" type="file" accept="image/*" style="display:none"></label>
          </div>
        </div>
        <div class="field">
          <label>Background image (URL or upload) <span class="note-chip">PNG/JPG</span></label>
          <div class="row-actions">
            <input id="e_bg" style="flex:1" placeholder="assets/amz.jpg">
            <label class="btn">Upload<input id="e_bg_file" type="file" accept="image/*" style="display:none"></label>
          </div>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div class="field">
          <label>Background mode</label>
          <select id="e_bg_mode">
            <option value="image" selected>Image</option>
            <option value="color">Solid color</option>
          </select>
        </div>
        <div class="field"><label>Background color</label><input id="e_bg_color" type="color" value="#0b2230"></div>
        <div class="field"><label>Payment reference</label><input id="e_ref" placeholder="M SHARE"></div>
      </div>

      <div class="field" style="margin-top:8px">
        <label>Address (one line per row)</label>
        <textarea id="e_addr" placeholder="Line 1&#10;Line 2&#10;City, Postcode&#10;Country"></textarea>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div class="field"><label>Account</label><input id="e_acc" placeholder="00000000"></div>
        <div class="field"><label>Sort</label><input id="e_sort" placeholder="000000"></div>
        <div class="field"><label>IBAN</label><input id="e_iban" placeholder="GB‚Ä¶"></div>
      </div>

      <div class="row-actions" style="margin-top:10px">
        <button id="downloadProfileJson" class="btn">‚¨á Download default_profile.json</button>
        <button id="resetProfile" class="btn btn-danger">‚ôª Restore file defaults</button>
        <span id="autoSaveState" class="subtle" style="margin-left:auto">Auto‚Äësaved</span>
      </div>
    </div>

    <div class="card">
      <h2>Cloud (Cloudflare R2 via Worker)</h2>
      <p class="muted">Publish the current styled PDF to Cloudflare R2, or load a profile by ID. Your Worker from <code>src/worker.js</code> handles <code>/api/profile</code>.</p>
      <div class="grid-3">
        <div class="field"><label>Base URL</label><input id="cloudBase" placeholder="https://mindpaylink.com" /></div>
        <div class="field"><label>Upload key (optional)</label><input id="cloudKey" placeholder="x-upload-key" /></div>
        <div class="field"><label>Load ID</label><input id="cloudLoadId" placeholder="abcdef-1234" /></div>
      </div>
      <div class="row-actions" style="margin-top:10px">
        <button id="btnPublish" class="btn btn-success">‚¨Ü Publish current PDF</button>
        <button id="btnLoadCloud" class="btn">‚¨á Load profile by ID</button>
        <span id="cloudStatus" class="subtle"></span>
      </div>
      <div id="cloudLinks" class="subtle" style="margin-top:6px"></div>
    </div>
  </div>
</main>

<!-- ===== SHARE SHEET (enhanced) ===== -->
<div id="shareSheet" class="sheet hidden" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
  <div id="shareBackdrop" style="position:absolute; inset:0;"></div>
  <div class="sheet-card">
    <div class="sheet-head">
      <h2 id="shareTitle" class="sheet-title">Share</h2>
      <button id="shareClose" class="sheet-close" aria-label="Close">√ó</button>
    </div>
    <textarea id="shareText" class="share-text" readonly></textarea>
    <div class="share-actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn" id="copyShare">üìã Copy link</button>
      <button class="btn" id="shareNative">üîó Share link‚Ä¶</button>
      <button class="btn" id="savePng">üñºÔ∏è Save PNG</button>
      <button class="btn" id="sharePng">üì§ Share PNG‚Ä¶</button>
      <button class="btn" id="sharePdf">üìÑ Share PDF‚Ä¶</button>
    </div>
  </div>
</div>

<!-- Embedded default profile JSON (used if localStorage and assets/default_profile.json are empty) -->
<script id="defaultProfileJson" type="application/json">
{
  "name": "Alkhadi Koroma",
  "title": "Flutter Mobile App Developer",
  "phone": "+44 7000 000000",
  "email": "alkhadi@example.com",
  "site": "https://example.com",
  "wellbeing": "index.html",
  "addr": "Southwark\nLondon SE1\nUnited Kingdom",
  "avatar": "assets/alkhadi.png",
  "bg": "assets/amz.jpg",
  "acc": "00000000",
  "sort": "00-00-00",
  "iban": "GB00EXAMPLE0000000000",
  "ref": "M SHARE",
  "bgMode": "image",
  "bgColor": "#0b2230"
}
</script>

<!-- Optional external helper; page works even if this 404s -->
<script src="app.js" defer></script>

<script>
(async function () {
  // ---------- Safe baseline ----------
  const MS = (window.__MSHARE__ = window.__MSHARE__ || {});
  const $ = (s, el=document)=> el.querySelector(s);
  const LOCAL_KEY = 'mshare_default_profile_v2';

  // Minimal toast fallback
  MS.toast = MS.toast || function(msg){
    try{
      let t = document.getElementById('mshare_toast');
      if(!t){ t=document.createElement('div'); t.id='mshare_toast';
        t.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0ea5e9;color:#001018;padding:10px 14px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:2000;font-weight:600';
        document.body.appendChild(t);
      }
      t.textContent = String(msg||'Done');
      t.style.opacity='1';
      setTimeout(()=>{ t.style.transition='opacity .4s ease'; t.style.opacity='0'; }, 1500);
    }catch{ alert(msg); }
  };

  // Mobile nav toggle (if you need it)
  const nav = $('#mainNav'), navToggle = $('#navToggle');
  if (nav && navToggle){
    navToggle.addEventListener('click', ()=>{ const open = getComputedStyle(nav).display !== 'none'; nav.style.display = open ? 'none':'flex'; });
  }

  // ---------- Ensure profile data (localStorage -> assets/default_profile.json -> embedded JSON -> static defaults)
  async function ensureProfileData(){
    let data = {};
    try { data = JSON.parse(localStorage.getItem(LOCAL_KEY)||'{}')||{}; } catch {}
    let hasAny = Object.values(data||{}).some(v=>String(v||'').trim()!=='');
    if (!hasAny){
      try{
        const r = await fetch('assets/default_profile.json', {cache:'no-store'});
        if (r.ok){ const j = await r.json(); data = Object.assign({}, j); }
      }catch{}
      hasAny = Object.values(data||{}).some(v=>String(v||'').trim()!=='');
    }
    if (!hasAny){
      try{
        const tag = document.getElementById('defaultProfileJson');
        if (tag?.textContent){ const j = JSON.parse(tag.textContent); data = Object.assign({}, j); }
      }catch{}
      hasAny = Object.values(data||{}).some(v=>String(v||'').trim()!=='');
    }
    if (!hasAny){
      data = {
        name: 'Alkhadi Koroma',
        title: 'Flutter Mobile App Developer',
        phone: '+44 7000 000000',
        email: 'alkhadi@example.com',
        site: 'https://example.com',
        wellbeing: 'index.html',
        addr: 'Southwark\nLondon SE1\nUnited Kingdom',
        avatar: 'assets/alkhadi.png',
        bg: 'assets/amz.jpg',
        acc: '00000000',
        sort: '00-00-00',
        iban: 'GB00EXAMPLE0000000000',
        ref: 'M SHARE',
        bgMode: 'image',
        bgColor: '#0b2230'
      };
    }
    try { localStorage.setItem(LOCAL_KEY, JSON.stringify(data)); } catch {}
    MS.data = MS.data || {};
    Object.assign(MS.data, data);
  }

  await ensureProfileData();

  // ---------- Utils ----------
  function loadImg(src){ return new Promise(res=>{ if(!src) return res(null); const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
  function roundRectPath(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // Helpful links bundle from data
  function linkBundle(d){
    const qp = new URLSearchParams({
      n:d.name||'', title:d.title||'', ph:d.phone||'', em:d.email||'', s:d.site||'',
      a:d.addr||'', av:d.avatar||'', bg:d.bg||'', wb:d.wellbeing||'',
      ac:d.acc||'', sc:d.sort||'', ib:d.iban||'', r:d.ref||''
    });
    const qs = Array.from(qp.entries()).filter(([k,v])=>String(v).trim()!=='').length ? ('?'+qp.toString()) : '';
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(d.addr||'').replace(/\n/g,' '))}`;
    const coffee = location.origin + location.pathname.replace(/[^/]*$/,'') + 'bank.html' + qs;
    const about = location.href.split('#')[0] + '#about';
    return {
      tel: d.phone?`tel:${d.phone}`:'',
      sms: d.phone?`sms:${d.phone}`:'',
      mail: d.email?`mailto:${d.email}`:'',
      site: d.site||'',
      wellbeing: d.wellbeing||'',
      maps, coffee, about
    };
  }

  // ---------- QR with avatar center ----------
  async function buildQR(text, size, avatarUrl){
    const base = await loadImg(`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`);
    const cnv = Object.assign(document.createElement('canvas'), {width:size, height:size});
    const cx = cnv.getContext('2d'); cx.fillStyle='#fff'; cx.fillRect(0,0,size,size);
    if (base) cx.drawImage(base,0,0,size,size);
    if (avatarUrl){
      const av = await loadImg(avatarUrl);
      if (av){
        const r = Math.round(size*0.20), x=size/2, y=size/2;
        cx.save(); cx.beginPath(); cx.arc(x,y,r,0,Math.PI*2); cx.closePath(); cx.clip(); cx.drawImage(av, x-r, y-r, r*2, r*2); cx.restore();
        cx.lineWidth=5; cx.strokeStyle='rgba(255,255,255,.98)'; cx.beginPath(); cx.arc(x,y,r,0,Math.PI*2); cx.stroke();
      }
    }
    return cnv;
  }

  // ---------- Build canvas (profile card) ----------
  async function buildProfileCanvas({canvas, includeQR=true, bgMode, bgColor} = {}){
    const d = MS.data || {};
    const W = 1224, H = 1584;
    const cnv = canvas || Object.assign(document.createElement('canvas'), { width: W, height: H });
    const ctx = cnv.getContext('2d');

    // background
    if ((bgMode||d.bgMode)==='color'){
      ctx.fillStyle = bgColor || d.bgColor || '#0b2230';
      ctx.fillRect(0,0,W,H);
    } else {
      ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
      const bg = await loadImg(d.bg || 'assets/amz.jpg');
      if (bg) ctx.drawImage(bg,0,0,W,H);
      const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'rgba(0,0,0,.15)'); g.addColorStop(1,'rgba(0,0,0,.55)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    }

    // QR -> About on this page
    let links = [];
    if (includeQR){
      const url = location.href.split('#')[0] + '#about';
      const qr = await buildQR(url, 280, d.avatar || 'assets/alkhadi.png');
      const qx=W-320, qy=80; ctx.drawImage(qr, qx, qy);
      ctx.fillStyle='rgba(255,255,255,.95)'; ctx.font='500 20px ui-sans-serif,system-ui,Segoe UI,Roboto'; ctx.textAlign='center';
      ctx.fillText('Scan: open About', qx+140, qy+300);
      links.push({x:qx, y:qy, w:qr.width, h:qr.height, url});
    }

    // avatar ring
    const AV=360, cx=W/2, cy=330;
    const av = await loadImg(d.avatar || 'assets/alkhadi.png');
    ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,AV/2,0,Math.PI*2); ctx.closePath(); ctx.fillStyle='#0b0b0b'; ctx.fill();
    if (av) { ctx.clip(); ctx.drawImage(av, cx-AV/2, cy-AV/2, AV, AV); }
    ctx.restore();
    ctx.lineWidth=8; ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.beginPath(); ctx.arc(cx,cy,AV/2,0,Math.PI*2); ctx.stroke();

    // name/title
    ctx.textAlign='center'; ctx.fillStyle='#fff';
    ctx.font='bold 58px ui-sans-serif,system-ui,Segoe UI,Roboto'; ctx.fillText(d.name||'', cx, cy+AV/2+72);
    ctx.font='600 34px ui-sans-serif,system-ui,Segoe UI,Roboto'; ctx.fillStyle='rgba(255,255,255,.95)'; ctx.fillText(d.title||'', cx, cy+AV/2+120);

    // address
    ctx.font='500 28px ui-sans-serif,system-ui,Segoe UI,Roboto'; ctx.fillStyle='rgba(236,253,245,.94)'; ctx.textAlign='center';
    const lines = String(d.addr||'').split('\n').filter(Boolean);
    const baseY = cy + AV/2 + 170; lines.forEach((ln,i)=> ctx.fillText(ln, cx, baseY + i*34));

    // 4% gap
    const gapAfterAddr = H * 0.04;

    // buttons (7, 3 rows: 2+2+2, then centered 1)
    const bx=160, gw=W-320, gap=16, bh=74, cw=(gw-gap)/2;
    const by = baseY + (lines.length ? (lines.length-1)*34 + 40 : 0) + gapAfterAddr;
    ctx.font='600 28px ui-sans-serif,system-ui,Segoe UI,Roboto'; ctx.textAlign='center';

    const qp = new URLSearchParams({
      n:d.name||'', title:d.title||'', ph:d.phone||'', em:d.email||'', s:d.site||'',
      a:d.addr||'', av:d.avatar||'', bg:d.bg||'', wb:d.wellbeing||'',
      ac:d.acc||'', sc:d.sort||'', ib:d.iban||'', r:d.ref||''
    });
    const qs = Array.from(qp.entries()).filter(([k,v])=>String(v).trim()!=='').length ? ('?'+qp.toString()) : '';
    const coffeeUrl = location.origin + location.pathname.replace(/[^/]*$/,'') + 'bank.html' + qs;
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(d.addr||'').replace(/\n/g,' '))}`;

    const btns = [
      { label:'üìû Call', url:(d.phone?`tel:${d.phone}`:'') },
      { label:'üí¨ Text', url:(d.phone?`sms:${d.phone}`:'') },
      { label:'‚úâÔ∏è Email', url:(d.email?`mailto:${d.email}`:'') },
      { label:'üåê Website', url:d.site||'' },
      { label:'üßò Wellbeing', url:d.wellbeing||'' },
      { label:'üó∫Ô∏è Directions', url:mapsUrl },
      { label:'üí∑ Buy me coffee', url:coffeeUrl }
    ];
    function drawButton(x,y,w,h,label,href){
      ctx.fillStyle='rgba(0,0,0,.45)'; ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=2;
      roundRectPath(ctx,x,y,w,h,14); ctx.fill(); ctx.stroke();
      ctx.fillStyle='#e5f7ff'; ctx.fillText(label, x+w/2, y+h/2+10);
      if (href) links.push({x,y,w,h,url:href});
    }
    for (let i=0;i<6;i++){ const r=Math.floor(i/2), c=i%2; const x=bx+c*(cw+gap), y=by+r*(bh+gap); drawButton(x,y,cw,bh,btns[i].label,btns[i].url); }
    const last=btns[6]; const centerX = bx + (gw - cw)/2; const lastY = by + 3*(bh+gap); drawButton(centerX,lastY,cw,bh,last.label,last.url);

    return { canvas: cnv, links };
  }

  // ---------- PDF with active links ----------
  function base64ToBytes(b64){ const bin=atob(b64.replace(/^data:.*;base64,/,''));
    const len=bin.length, out=new Uint8Array(len); for(let i=0;i<len;i++) out[i]=bin.charCodeAt(i); return out; }
  function parseJpegSize(bytes){ let i=2; while(i<bytes.length){ if(bytes[i]!==0xFF){ i++; continue; }
    const marker=bytes[i+1]; const len=(bytes[i+2]<<8)|bytes[i+3]; if(marker>=0xC0&&marker<=0xC3){ return {h:(bytes[i+5]<<8)|bytes[i+6], w:(bytes[i+7]<<8)|bytes[i+8]}; } i+=2+len; } return {w:1224,h:1584}; }

  async function pdfFromCanvasWithLinks({fromCanvas, links=[]}){
    const jpeg = fromCanvas.toDataURL('image/jpeg', .92);
    const imgBytes = base64ToBytes(jpeg);
    const dim = parseJpegSize(imgBytes);

    const PW=595, PH=842; // A4
    const content = `q\n${PW} 0 0 ${PH} 0 0 cm\n/Im0 Do\nQ\n`;
    const enc = new TextEncoder();
    const chunks = []; const offs=[]; let off=0;
    function push(b){ const a = (typeof b==='string')? enc.encode(b): b; offs.push(off); chunks.push(a); off+=a.length; }
    function obj(n, body){ push(`${n} 0 obj\n`); push(body); push(`\nendobj\n`); }

    const annots = links.map(a=>{
      const sx = PW/1224, sy = PH/1584;
      const x1=a.x*sx, y1=PH-(a.y+a.h)*sy, x2=(a.x+a.w)*sx, y2=PH-(a.y)*sy;
      return { rect:[x1,y1,x2,y2], url:a.url||'' };
    });

    push('%PDF-1.4\n%\xC2\xB5\xC2\xB7\n');
    obj(1, `<< /Type /Catalog /Pages 2 0 R >>`);
    obj(2, `<< /Type /Pages /Count 1 /Kids [3 0 R] >>`);
    const annRefs = annots.map((_,i)=>`${6+i} 0 R`).join(' ');
    obj(3, `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${PW} ${PH}] /Resources << /XObject << /Im0 5 0 R >> /ProcSet [/PDF /ImageC] >> /Contents 4 0 R ${annots.length?('/Annots ['+annRefs+']'):''} >>`);
    const contentBytes = enc.encode(content);
    obj(4, `<< /Length ${contentBytes.length} >>\nstream\n${content}endstream`);
    obj(5, `<< /Type /XObject /Subtype /Image /Name /Im0 /Width ${dim.w} /Height ${dim.h} /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${imgBytes.length} >>\nstream\n`);
    push(imgBytes); push(`\nendstream\nendobj\n`);
    annots.forEach((a,i)=>{
      const rect = a.rect.map(v=>v.toFixed(2)).join(' ');
      obj(6+i, `<< /Type /Annot /Subtype /Link /Border [0 0 0] /Rect [${rect}] /A << /S /URI /URI (${a.url.replace(/[()]/g, '\\$&')}) >> >>`);
    });
    const xrefStart = off; push('xref\n'); const count = 6+annots.length;
    push(`0 ${count+1}\n`); push('0000000000 65535 f \n');
    for(let i=0;i<count;i++){ push(String(offs[i]).padStart(10,'0') + ' 00000 n \n'); }
    push(`trailer << /Size ${count+1} /Root 1 0 R >>\nstartxref\n${xrefStart}\n%%EOF`);
    return new Blob(chunks.map(a=>a.buffer?a:new Uint8Array(a)), {type:'application/pdf'});
  }

  // ---------- PUBLIC PROFILE DATA RENDER ----------
  function renderProfileData(){
    const d = MS.data || {};
    const L = linkBundle(d);
    const el = $('#profileData');
    const esc = (s)=> String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const addrHtml = esc(d.addr||'').replace(/\n/g,'<br>');
    el.innerHTML = `
      <div class="k">Name</div><div class="v">${esc(d.name||'‚Äî')}</div>
      <div class="k">Title</div><div class="v">${esc(d.title||'‚Äî')}</div>
      <div class="k">Phone</div><div class="v">${d.phone? `<a href="${L.tel}">${esc(d.phone)}</a> ¬∑ <a href="${L.sms}">Text</a>`:'‚Äî'}</div>
      <div class="k">Email</div><div class="v">${d.email? `<a href="${L.mail}">${esc(d.email)}</a>`:'‚Äî'}</div>
      <div class="k">Website</div><div class="v">${d.site? `<a href="${esc(d.site)}" target="_blank" rel="noopener">${esc(d.site)}</a>`:'‚Äî'}</div>
      <div class="k">Wellbeing</div><div class="v">${d.wellbeing? `<a href="${esc(d.wellbeing)}">${esc(d.wellbeing)}</a>`:'‚Äî'}</div>
      <div class="k">Address</div><div class="v">${addrHtml || '‚Äî'} ${d.addr? ` ¬∑ <a href="${L.maps}" target="_blank" rel="noopener">Directions</a>`:''}</div>
      <div class="k">Buy me coffee</div><div class="v"><a href="${L.coffee}">bank.html</a></div>
      <div class="k">Avatar</div><div class="v">${d.avatar? `<img class="thumb" src="${esc(d.avatar)}" alt="Avatar preview"> <code>${esc(d.avatar)}</code>`:'‚Äî'}</div>
      <div class="k">Background</div><div class="v">${d.bg? `<img class="thumb-bg" src="${esc(d.bg)}" alt="Background preview"> <code>${esc(d.bg)}</code>`:'‚Äî'}</div>
      <div class="k">Background mode</div><div class="v">${esc(d.bgMode||'image')} ${d.bgMode==='color'? `¬∑ <span style="display:inline-block;width:14px;height:14px;border-radius:3px;border:1px solid var(--b);vertical-align:middle;background:${esc(d.bgColor||'#0b2230')}"></span> <code>${esc(d.bgColor||'#0b2230')}</code>`:''}</div>
      <div class="k">Account</div><div class="v">${esc(d.acc||'‚Äî')}</div>
      <div class="k">Sort</div><div class="v">${esc(d.sort||'‚Äî')}</div>
      <div class="k">IBAN</div><div class="v">${esc(d.iban||'‚Äî')}</div>
      <div class="k">Payment reference</div><div class="v">${esc(d.ref||'‚Äî')}</div>
    `;
  }

  // ---------- Public preview + actions ----------
  const canvas = $('#pdfPreview');
  let built = await buildProfileCanvas({ canvas, includeQR:true });

  renderProfileData(); // <-- ensures the default profile is visible immediately

  $('#downloadPdf').addEventListener('click', async ()=>{
    try{
      const blob = await pdfFromCanvasWithLinks({ fromCanvas: built.canvas, links: built.links });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='m_share_profile.pdf';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),8000);
    }catch(e){ MS.toast('Could not generate PDF.'); }
  });

  $('#savePreview').addEventListener('click', ()=>{
    built.canvas.toBlob(b=>{
      const url = URL.createObjectURL(b);
      const a = document.createElement('a'); a.href=url; a.download='m_share_profile_preview.png';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),8000);
    }, 'image/png', .95);
  });

  // ---------- Enhanced Share ----------
  const shareSheet = $('#shareSheet'), shareText = $('#shareText');
  const openShare = async ()=>{
    const d = MS.data||{}; const L = linkBundle(d);
    const lines = [
      d.name ? `${d.name}${d.title? ' ‚Äî '+d.title : ''}` : 'My profile',
      d.site || '',
      'About: ' + L.about
    ].filter(Boolean);
    shareText.value = lines.join('\n');
    shareSheet.classList.remove('hidden');
  };
  $('#shareOpen').addEventListener('click', openShare);
  $('#shareClose').addEventListener('click', ()=> shareSheet.classList.add('hidden'));
  $('#shareBackdrop').addEventListener('click', ()=> shareSheet.classList.add('hidden'));

  $('#copyShare').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(shareText.value); MS.toast('Link copied'); }catch{ alert('Link copied'); }
  });

  $('#shareNative').addEventListener('click', async ()=>{
    const d = MS.data||{}; const L = linkBundle(d);
    try{
      if (navigator.share){
        await navigator.share({ title: document.title, text: shareText.value, url: L.about });
      } else {
        await navigator.clipboard.writeText(L.about);
        MS.toast('Link copied');
      }
    }catch{}
  });

  $('#savePng').addEventListener('click', ()=>{
    built.canvas.toBlob(b=>{
      const url = URL.createObjectURL(b);
      const a = document.createElement('a'); a.href=url; a.download='m_share_profile_preview.png';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),8000);
    }, 'image/png', .95);
  });

  $('#sharePng').addEventListener('click', ()=>{
    built.canvas.toBlob(async b=>{
      try{
        const file = new File([b], 'm_share_profile.png', {type:'image/png'});
        if (navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], title: document.title, text: shareText.value });
        } else {
          const url = URL.createObjectURL(b);
          const a = document.createElement('a'); a.href=url; a.download='m_share_profile.png';
          document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),8000);
        }
      }catch{}
    }, 'image/png', .95);
  });

  $('#sharePdf').addEventListener('click', async ()=>{
    try{
      const blob = await pdfFromCanvasWithLinks({ fromCanvas: built.canvas, links: built.links });
      const file = new File([blob], 'm_share_profile.pdf', {type:'application/pdf'});
      if (navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({ files:[file], title: document.title, text: shareText.value });
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='m_share_profile.pdf';
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),8000);
      }
    }catch{}
  });

  // ---------- Admin lock ----------
  const PASS_SHA256 = '157bf2223fbe33cc45b079053573833afa453b46bb28b23510067c9ccfbaf327';
  const LOCK_KEY = 'mshare_admin_lock_v3';
  function loadLock(){ try{ return JSON.parse(localStorage.getItem(LOCK_KEY)||'{}'); }catch{ return {}; } }
  function saveLock(s){ try{ localStorage.setItem(LOCK_KEY, JSON.stringify(s)); }catch{} }
  async function sha256(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256',enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function nextDelayMs(tries){ if(tries<=2) return 0; if(tries===3) return 10*60*1000; if(tries===4) return 30*60*1000; if(tries===5) return 60*60*1000; if(tries===6) return 2*24*60*60*1000; if(tries===7) return 90*24*60*60*1000; if(tries===8) return 180*24*60*60*1000; return Infinity; }
  function showAdminDeck(){ const deck = $('#adminDeck'); deck.classList.remove('admin-only'); deck.style.display='block'; }

  const modal=$('#adminModal'), passInp=$('#adminPass'), togglePass=$('#togglePass'), timerEl=$('#lockTimer'), lockMsg=$('#lockMessage');
  $('#adminUnlockBtn').addEventListener('click', ()=>{ modal.classList.add('open'); modal.removeAttribute('aria-hidden'); passInp.value=''; passInp.type='password'; timerEl.style.display='none'; lockMsg.textContent=''; refreshLockUI(); passInp.focus(); });
  $('#adminClose').addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
  togglePass.addEventListener('click', ()=>{ passInp.type = passInp.type==='password'?'text':'password'; });

  function refreshLockUI(){
    const s = loadLock(); const now=Date.now();
    if (s.perma){ passInp.disabled=true; $('#adminSubmit').disabled=true; lockMsg.textContent='Too many attempts. Permanently locked.'; return; }
    if (s.lockedUntil && now < s.lockedUntil){
      passInp.disabled=true; $('#adminSubmit').disabled=true;
      const tick=()=>{ const l=Math.max(0, (loadLock().lockedUntil||0)-Date.now());
        const mins=Math.floor(l/60000), secs=Math.floor((l%60000)/1000);
        timerEl.style.display='block';
        timerEl.textContent=`Locked. Try again in ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
        if (l<=0){ passInp.disabled=false; $('#adminSubmit').disabled=false; timerEl.style.display='none'; saveLock({ tries:(loadLock().tries||0) }); }
        else setTimeout(tick, 500);
      }; tick();
    } else {
      passInp.disabled=false; $('#adminSubmit').disabled=false; timerEl.style.display='none';
      lockMsg.textContent = (s.tries ? `Attempts so far: ${s.tries}` : '');
    }
  }

  $('#adminSubmit').addEventListener('click', async ()=>{
    const s = loadLock(); if (s.perma) return;
    const hash = await sha256(passInp.value||'');
    if (hash === PASS_SHA256){ sessionStorage.setItem('mshare_admin_ok','1'); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); saveLock({ tries:0 }); showAdminDeck(); mountStoreAndEditor(); return; }
    const tries = (s.tries||0)+1; const delay = nextDelayMs(tries);
    if (delay===Infinity){ saveLock({ tries, perma:true }); } else if (delay>0){ saveLock({ tries, lockedUntil: Date.now()+delay }); } else { saveLock({ tries }); }
    refreshLockUI(); MS.toast('Incorrect password');
  });

  // ---------- Device Locker patch + mount (optional) ----------
  function patchLockerUnlimited(){
    const DL = MS.DeviceLocker; if (!DL || DL.__patched) return;
    const oldMount = DL.mount?.bind(DL);
    DL.addBlob = async function(name, blob){ const base64 = await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(String(fr.result)); fr.readAsDataURL(blob); }); const rec={ name:name||'document.pdf', size: blob.size, mime: blob.type||'application/pdf', data: base64 }; const list=this.load(); list.push(rec); this.save(list); return true; };
    DL.import = async function(file){ const text=await file.text(); try{ const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error(); this.save(arr); }catch{ MS.toast('Invalid locker backup.'); } };
    DL.mount = function(opts){ oldMount?.(opts); try{ if(opts?.quotaEl) opts.quotaEl.textContent = DL.formatBytes(DL.usedBytes()) + ' / ‚àû'; }catch{} };
    DL.__patched = true;
  }

  function mountStoreAndEditor(){
    patchLockerUnlimited();
    MS.DeviceLocker?.mount?.({
      listEl: $('#lockerList'),
      quotaEl: $('#lockerQuota'),
      addInput: $('#addPdf'),
      placeholderBtn: $('#makePlaceholder'),
      exportBtn: $('#exportLocker'),
      importInput: $('#importLocker'),
      previewBuilder: async ()=> {
        const fresh = await buildProfileCanvas({ includeQR:true, bgMode: MS.data?.bgMode, bgColor: MS.data?.bgColor });
        return pdfFromCanvasWithLinks({ fromCanvas: fresh.canvas, links: fresh.links });
      }
    });

    // Save current preview to store
    $('#saveToStore')?.addEventListener('click', async ()=>{
      try{
        const blob = await pdfFromCanvasWithLinks({ fromCanvas: built.canvas, links: built.links });
        const ok = await MS.DeviceLocker?.addBlob?.('m_share_profile.pdf', blob);
        if (ok) MS.toast('Saved to Store.');
      }catch{ MS.toast('Could not save to Store'); }
    });

    // Editor fill/read helpers
    function fillEditor(d){
      $('#e_name').value=d.name||''; $('#e_title').value=d.title||'';
      $('#e_phone').value=d.phone||''; $('#e_email').value=d.email||'';
      $('#e_site').value=d.site||''; $('#e_wb').value=d.wellbeing||'';
      $('#e_avatar').value=d.avatar||''; $('#e_bg').value=d.bg||'';
      $('#e_addr').value=d.addr||''; $('#e_acc').value=d.acc||'';
      $('#e_sort').value=d.sort||''; $('#e_iban').value=d.iban||'';
      $('#e_ref').value=d.ref||''; $('#e_bg_mode').value=d.bgMode||'image';
      $('#e_bg_color').value=d.bgColor||'#0b2230';
    }
    function readEditor(){
      return {
        name:$('#e_name').value.trim(), title:$('#e_title').value.trim(), phone:$('#e_phone').value.trim(),
        email:$('#e_email').value.trim(), site:$('#e_site').value.trim(), wellbeing:$('#e_wb').value.trim(),
        avatar:$('#e_avatar').value.trim(), bg:$('#e_bg').value.trim(), addr:$('#e_addr').value,
        acc:$('#e_acc').value.trim(), sort:$('#e_sort').value.trim(), iban:$('#e_iban').value.trim(),
        ref:$('#e_ref').value.trim(), bgMode:$('#e_bg_mode').value, bgColor:$('#e_bg_color').value
      };
    }

    fillEditor(MS.data||{});

    async function redraw(){
      built = await buildProfileCanvas({ canvas, includeQR:true, bgMode: MS.data.bgMode, bgColor: MS.data.bgColor });
      renderProfileData();
    }
    const saveAndRedraw = debounce(async ()=>{
      $('#autoSaveState').textContent='Saving‚Ä¶';
      MS.data = Object.assign(MS.data || {}, readEditor());
      try { localStorage.setItem(LOCAL_KEY, JSON.stringify(MS.data)); } catch {}
      await redraw(); $('#autoSaveState').textContent='Auto‚Äësaved';
    }, 300);

    document.querySelectorAll('#adminDeck input, #adminDeck textarea, #adminDeck select')
      .forEach(el => el.addEventListener('input', saveAndRedraw));

    $('#e_avatar_file')?.addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ $('#e_avatar').value=String(fr.result||''); saveAndRedraw(); }; fr.readAsDataURL(f);
    });
    $('#e_bg_file')?.addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ $('#e_bg').value=String(fr.result||''); saveAndRedraw(); }; fr.readAsDataURL(f);
    });

    $('#downloadProfileJson')?.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(MS.data||{},null,2)], {type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='default_profile.json';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),8000);
    });

    $('#resetProfile')?.addEventListener('click', ()=>{
      if (!confirm('Restore file defaults? This clears device overrides.')) return;
      try { localStorage.removeItem(LOCAL_KEY); } catch {}
      location.reload();
    });

    $('#cloudBase') && ($('#cloudBase').value = location.origin);
    async function publishToCloud(){
      try{
        $('#cloudStatus').textContent='Generating PDF‚Ä¶';
        const blob = await pdfFromCanvasWithLinks({ fromCanvas: built.canvas, links: built.links });
        const fd = new FormData();
        const meta = {
          name: MS.data.name||'', title:MS.data.title||'', phone:MS.data.phone||'', email:MS.data.email||'',
          site: MS.data.site||'', addr: MS.data.addr||'', avatar: MS.data.avatar||'',
          payee_full_name: MS.data.name||'', bank_name: '', account_number: MS.data.acc||'',
          sort_code: MS.data.sort||'', iban: MS.data.iban||'', reference: MS.data.ref||''
        };
        fd.append('pdf', new File([blob], 'profile.pdf', {type:'application/pdf'}));
        fd.append('meta', JSON.stringify(meta));
        const base=($('#cloudBase').value||location.origin).replace(/\/$/,''); const key=$('#cloudKey').value?.trim?.()||'';
        const r = await fetch(base+'/api/profile', { method:'POST', headers: key?{'x-upload-key':key}:{}, body: fd });
        if(!r.ok){ throw new Error('Upload failed'); }
        const j = await r.json();
        $('#cloudStatus').textContent='Published.';
        $('#cloudLinks').innerHTML = `<div>Public URL: <a href="${base}/p/${j.id}" target="_blank" rel="noopener">${base}/p/${j.id}</a></div>
          <div>PDF: <a href="${base}${j.pdf?.url||('/p/'+j.id+'.pdf')}" target="_blank" rel="noopener">${base}${j.pdf?.url||('/p/'+j.id+'.pdf')}</a></div>`;
      }catch(e){ $('#cloudStatus').textContent='Error publishing.'; }
    }
    async function loadFromCloud(){
      try{
        const base=($('#cloudBase').value||location.origin).replace(/\/$/,''); const id=$('#cloudLoadId').value?.trim?.()||'';
        if(!id) return;
        $('#cloudStatus').textContent='Loading meta‚Ä¶';
        const r = await fetch(base+'/api/profile/'+encodeURIComponent(id)); if(!r.ok) throw new Error();
        const m = await r.json();
        Object.assign(MS.data, { name:m.name||'', title:m.title||'', phone:m.phone||'', email:m.email||'', site:m.site||'', addr:m.addr||'', avatar:m.avatar||'' });
        try { localStorage.setItem(LOCAL_KEY, JSON.stringify(MS.data)); } catch {}
        built = await buildProfileCanvas({ canvas, includeQR:true, bgMode: MS.data.bgMode, bgColor: MS.data.bgColor });
        renderProfileData();
        $('#cloudStatus').textContent='Loaded.';
      }catch{ $('#cloudStatus').textContent='Load failed.'; }
    }
    $('#btnPublish')?.addEventListener('click', publishToCloud);
    $('#btnLoadCloud')?.addEventListener('click', loadFromCloud);
  }

  // If unlocked earlier in this tab, show deck immediately
  if (sessionStorage.getItem('mshare_admin_ok') === '1') { showAdminDeck(); mountStoreAndEditor(); }

  // Keep preview + public data in sync when profile changes elsewhere
  window.addEventListener('storage', async (e)=>{
    if (e.key === LOCAL_KEY){
      try{
        const d=JSON.parse(e.newValue||'{}'); MS.data = Object.assign(MS.data||{}, d||{});
        built = await buildProfileCanvas({ canvas, includeQR:true, bgMode: MS.data.bgMode, bgColor: MS.data.bgColor });
        renderProfileData();
      }catch{}
    }
  });
})();
</script>
</body>
</html>
