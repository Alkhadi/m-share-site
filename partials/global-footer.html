<footer id="footer2025" class="footer-2025 mpl-footer-v3" role="contentinfo" aria-label="Site footer">
  <div class="mpl-footer-wrap">
    <div class="mpl-footer-grid" role="navigation" aria-label="Footer navigation">
      <section class="col brand">
        <div class="brandline">
          <span class="logo" aria-hidden="true">M</span>
          <div>
            <b>M Share</b>
            <div class="muted">Quiet, practical tools for mental health and wellbeing.</div>
          </div>
        </div>
        <div class="mpl-pay" aria-label="Support links">
          <a class="pay-link" href="coffee.html" rel="noopener">Support Us</a>
          <a class="pay-link" href="https://buy.stripe.com/28E4gy5j6cmD2wu3pk4Rq00" rel="noopener">☕ Support Us</a>
        </div>
      </section>

      <section class="col center">
        <div id="mpl-theme" class="theme-explorer" aria-label="Theme">
          <button data-theme="system" class="theme-btn" aria-pressed="false">System</button>
          <button data-theme="light" class="theme-btn" aria-pressed="false">Light</button>
          <button data-theme="dark" class="theme-btn" aria-pressed="false">Dark</button>
        </div>
        <nav class="quick-links" aria-label="Quick links">
          <a href="index.html">Home</a>
          <a href="resources.html">Resources</a>
          <a href="downloads.html">Downloads</a>
          <a href="contact.html">Contact</a>
        </nav>
      </section>

      <section class="col right">
        <nav aria-label="Tools">
          <a href="breath.html">Breathing</a>
          <a href="mindfulness.html">Mindfulness</a>
          <a href="dyslexia-reading-training.html">Dyslexia Training</a>
          <a href="sos.html">SOS 60</a>
        </nav>
        <div class="legal muted">
          <span>&copy; <span id="mpl-year"></span> M Share</span>
          <a href="storage.html">Privacy</a>
        </div>
      </section>
    </div>
  </div>
  <script>
    (function () {
      var y = document.getElementById("mpl-year");
      if (y) y.textContent = new Date().getFullYear();
      var root = document.documentElement;
      var btns = document.querySelectorAll(".theme-btn");
      btns.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var t = btn.getAttribute("data-theme");
          localStorage.setItem("mpl_theme", t);
          root.dataset.theme = t;
          btns.forEach(function (x) { x.setAttribute("aria-pressed", String(x === btn)); });
        });
      });
      var saved = localStorage.getItem("mpl_theme") || "system";
      root.dataset.theme = saved;
      btns.forEach(function (x) { x.setAttribute("aria-pressed", String(x.getAttribute("data-theme") === saved)); });
    })();
  </script>
  <a class="footer-home-link" href="/" aria-label="Go to homepage"><img src="alkhadi.png" alt="Home" loading="lazy" decoding="async"/></a>
</footer>
'EOF'

# 2) Footer injector (uses RegExp **string** to avoid literal issues)
cat > scripts/fix-footer-only.mjs << 'EOF'
import fs from "fs";
import path from "path";

const ROOT = process.cwd();
const PARTIAL = path.join(ROOT, "partials", "global-footer.html");
if (!fs.existsSync(PARTIAL)) { console.error("❌ Missing partials/global-footer.html"); process.exit(1); }
const FOOT = fs.readFileSync(PARTIAL, "utf8").trim();

function ensureInHead(html, tagHtml) {
  const headClose = /<\/head>/i;
  if (!headClose.test(html)) return html;
  if (html.includes(tagHtml)) return html;
  return html.replace(headClose, `  ${tagHtml}\n</head>`);
}

const rxFooter = new RegExp("<footer[\\\\s\\\\S]*?<\\\\/footer>", "i"); // string-based regex

const files = fs.readdirSync(ROOT).filter(f => f.endsWith(".html"));
const summary = { updated: [], inserted: [], ensuredCss: 0 };

for (const f of files) {
  const p = path.join(ROOT, f);
  let html = fs.readFileSync(p, "utf8");
  const before = html;

  // Ensure footer CSS once
  const NEED = `<link rel="stylesheet" href="footer-2025.css" />`;
  const next = ensureInHead(html, NEED);
  if (next !== html) { html = next; summary.ensuredCss = 1; }

  // Replace existing <footer>… or insert before </body>
  if (rxFooter.test(html)) {
    html = html.replace(rxFooter, FOOT);
    summary.updated.push(f);
  } else if (/<\\/body>/i.test(html)) {
    html = html.replace(/<\\/body>/i, `${FOOT}\n</body>`);
    summary.inserted.push(f);
  }

  if (html !== before) fs.writeFileSync(p, html, "utf8");
}

console.log(JSON.stringify(summary, null, 2));
'EOF'

# 3) Run, commit, push (default: main; set BRANCH_OVERRIDE=gh-pages to stage)
node scripts/fix-footer-only.mjs | tee /tmp/fix_footer_only_summary.json

BRANCH="${BRANCH_OVERRIDE:-main}"
git fetch origin "$BRANCH" || true
git checkout -B "$BRANCH"
git add -A
HUSKY=0 git commit -m "Footer-only: apply canonical global footer to all pages" --no-verify || true
git push

echo
echo "──── Footer fix summary ────"
cat /tmp/fix_footer_only_summary.json || true
echo "Pushed to: $BRANCH"
