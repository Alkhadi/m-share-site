<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M Share — Storage (Admin)</title>
  <link rel="icon" href="icons/icon-192.png" />
  <style>
    :root { color-scheme: light dark; }
    body { font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg,#0f172a); color: var(--fg,#e5e7eb); }
    .wrap { max-width: min(1100px, 96vw); margin: 24px auto; padding: 0 8px; }
    header { padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,.12); }
    h1 { margin: 0; font-size: 24px; }
    .muted { color: #94a3b8; }
    .card { border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 14px; margin: 14px 0; background: rgba(0,0,0,.1); }
    .row { display:flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    input[type="text"], input[type="url"], input[type="password"], input[type="file"] { background: transparent; color: inherit; border:1px solid rgba(255,255,255,.2); border-radius:8px; padding:8px 10px; min-width: 260px; }
    button { background:#10b981; color:#06251c; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600; }
    button.secondary { background:transparent; color:inherit; border:1px solid rgba(255,255,255,.35); }
    .kv { display:flex; justify-content: space-between; gap: 10px; align-items: center; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.13); }
    .kv:last-child { border-bottom:0; }
    .status { margin-top: 8px; min-height: 20px; }
    a.btn { display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border:1px solid rgba(255,255,255,.25); border-radius:.5rem; text-decoration:none; color:inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Storage console <span class="muted">(Admin)</span></h1>
      <div class="muted">Upload PDFs to Cloudflare R2 and share links. This page is passcode‑gated.</div>
    </header>

    <section id="gate" class="card">
      <p>Admin check in progress…</p>
    </section>

    <section id="ui" class="card" style="display:none">
      <h2 style="margin:0 0 6px 0">Cloudflare R2 endpoint</h2>
      <div class="row" style="margin:6px 0 10px 0">
        <input id="r2Endpoint" type="url" placeholder="https://<your-worker>.<subdomain>.workers.dev/upload" style="flex:1; min-width:320px" />
        <input id="r2Token" type="password" placeholder="Bearer API token (optional if your worker uses cookies)" />
        <button id="saveCfg">Save</button>
        <button id="testCfg" class="secondary">Test</button>
      </div>
      <div class="muted">Bucket: mshare-profiles (recommended). You can change the key prefix per upload below.</div>
      <div id="cfgStatus" class="status muted"></div>
    </section>

    <section id="uploadBox" class="card" style="display:none">
      <h2 style="margin:0 0 6px 0">Upload a PDF</h2>
      <div class="row" style="margin:6px 0 10px 0">
        <input id="fileInput" type="file" accept="application/pdf" />
        <input id="keyPrefix" type="text" placeholder="key prefix (e.g. profiles/alkhadi/)" />
        <button id="uploadBtn">Upload</button>
        <button id="uploadPlaceholder" class="secondary">Generate profile PDF and upload</button>
      </div>
      <div id="upStatus" class="status"></div>
    </section>

    <section id="locker" class="card" style="display:none">
      <h2 style="margin:0 0 6px 0">Device locker PDFs</h2>
      <div id="lockerQuota" class="muted"></div>
      <div id="lockerList" style="margin-top:10px"></div>
    </section>

    <section class="card" style="display:none" id="help">
      <h2 style="margin:0 0 6px 0">How this works</h2>
      <ol style="margin:0 0 0 1.2rem; padding:0">
        <li>Deploy the Worker from cloudflare/worker-r2-upload.js with an R2 binding to your bucket (e.g. mshare-profiles).</li>
        <li>Paste the Worker upload URL above. Optional: add a Bearer token you validate in the Worker.</li>
        <li>Pick a PDF or generate one from your profile, then Upload. You’ll get a shareable link if the Worker returns one.</li>
      </ol>
      <p class="muted" style="margin:.6rem 0 0 0">Tip: Save the config. It’s stored only on this device.</p>
    </section>
  </div>

  <script src="app.js"></script>
  <script>
  (function(){
    const MS = window.__MSHARE__;
    const gate = document.getElementById('gate');
    const ui = document.getElementById('ui');
    const uploadBox = document.getElementById('uploadBox');
    const lockerBox = document.getElementById('locker');
    const help = document.getElementById('help');

    const epInput = document.getElementById('r2Endpoint');
    const tokInput = document.getElementById('r2Token');
    const saveBtn = document.getElementById('saveCfg');
    const testBtn = document.getElementById('testCfg');
    const cfgStatus = document.getElementById('cfgStatus');

    const fileInput = document.getElementById('fileInput');
    const keyPrefix = document.getElementById('keyPrefix');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const upStatus = document.getElementById('upStatus');

    const cfgKey = 'mshare_r2_cfg_v1';
    function loadCfg(){ try{ return JSON.parse(localStorage.getItem(cfgKey)||'{}'); }catch{ return {}; } }
    function saveCfg(cfg){ try{ localStorage.setItem(cfgKey, JSON.stringify(cfg)); }catch{} }

    function setStatus(el, msg, ok){ el.textContent = msg || ''; el.style.color = ok? '#10b981' : '#e5e7eb'; el.style.opacity = msg? 1 : .7; }

    async function requireAdmin(){
      try{ const ok = await MS.requireAdmin(); if(!ok) { gate.innerHTML = '<p>Admin required.</p>'; return false; } return true; }
      catch{ gate.innerHTML = '<p>Admin check failed.</p>'; return false; }
    }

    function initCfg(){ const cfg = loadCfg(); if(cfg.endpoint) epInput.value = cfg.endpoint; if(cfg.token) tokInput.value = cfg.token; keyPrefix.value = cfg.prefix || '' }

    function buildKey(name){ const pre = (keyPrefix.value||'').trim(); if(!pre) return name; return pre.replace(/(^\/+|\/+$)/g,'') + '/' + name.replace(/^\/+/, ''); }

    async function uploadBlob(blob, name){
      const cfg = loadCfg(); const endpoint = (epInput.value||cfg.endpoint||'').trim(); const token = (tokInput.value||cfg.token||'').trim();
      if(!endpoint){ setStatus(upStatus, 'Please set the Worker endpoint URL above.', false); return; }
      const key = buildKey(name||('document-'+Date.now()+'.pdf'));
      setStatus(upStatus, 'Uploading…', true);
      try{
        const url = endpoint + (endpoint.includes('?')?'&':'?') + new URLSearchParams({ name: key }).toString();
        const res = await fetch(url, { method:'POST', headers: Object.assign({ 'Content-Type':'application/pdf' }, token? { 'Authorization': 'Bearer '+token } : {}), body: blob });
        if(!res.ok){ const text = await res.text().catch(()=>res.statusText); throw new Error(text||('HTTP '+res.status)); }
        const out = await res.json().catch(()=>({ ok:true }));
        const link = out.url || out.download || out.href || '';
        setStatus(upStatus, 'Uploaded '+key + (link? ' — link copied to clipboard' : ''), true);
        try{ if(link) { await navigator.clipboard.writeText(link); MS.toast('Link copied'); } }catch{}
        return { key, link, out };
      }catch(err){ console.error(err); setStatus(upStatus, 'Upload failed: '+(err.message||String(err)), false); }
    }

    saveBtn.addEventListener('click', ()=>{
      const cfg = { endpoint: epInput.value.trim(), token: tokInput.value.trim(), prefix: keyPrefix.value.trim() };
      saveCfg(cfg); setStatus(cfgStatus, 'Saved.', true);
    });
    testBtn.addEventListener('click', async()=>{
      const cfg = loadCfg(); if(!epInput.value && !cfg.endpoint){ setStatus(cfgStatus, 'Set endpoint first.', false); return; }
      try{ const res = await fetch((epInput.value||cfg.endpoint)+'?ping=1', { method:'GET' }); setStatus(cfgStatus, res.ok? 'Endpoint reachable.' : 'Endpoint error: '+res.status, res.ok); }
      catch{ setStatus(cfgStatus, 'Endpoint not reachable.', false); }
    });

    uploadBtn.addEventListener('click', async()=>{
      const f = fileInput.files && fileInput.files[0]; if(!f){ MS.toast('Choose a PDF'); return; }
      await uploadBlob(f, f.name);
    });

    uploadPlaceholder.addEventListener('click', async()=>{
      try{
        const canvasPkg = await MS.buildStyledCardCanvas({ includeQR: true });
        const pdf = await MS.generateStyledPdf({ fromCanvas: canvasPkg.canvas, links: canvasPkg.links });
        await uploadBlob(pdf, 'm_share_profile.pdf');
      }catch(err){ console.error(err); MS.toast('Could not generate PDF'); }
    });

    // Mount locker list for manual downloads too
    function renderLocker(){
      const list = document.getElementById('lockerList'); const quota = document.getElementById('lockerQuota');
      MS.DeviceLocker.mount({ listEl:list, quotaEl:quota });
    }

    (async function start(){
      if(!(await requireAdmin())) return;
      gate.style.display = 'none'; ui.style.display='block'; uploadBox.style.display='block'; lockerBox.style.display='block'; help.style.display='block';
      initCfg(); renderLocker();
      // If URL provides ?endpoint=…&token=… we prefill
      const sp = new URLSearchParams(location.search);
      if(sp.get('endpoint')) epInput.value = sp.get('endpoint');
      if(sp.get('token')) tokInput.value = sp.get('token');
    })();
  })();
  </script>
</body>
</html>
